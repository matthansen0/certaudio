name: Generate Content

on:
  workflow_dispatch:
    inputs:
      certificationId:
        description: 'Microsoft certification ID'
        required: true
        type: choice
        options:
          # === AZURE ===
          - az-900     # Azure Fundamentals
          - az-104     # Azure Administrator
          - az-204     # Azure Developer
          - az-305     # Azure Solutions Architect Expert
          - az-400     # Azure DevOps Engineer Expert
          - az-500     # Azure Security Engineer
          - az-700     # Azure Network Engineer
          - az-140     # Azure Virtual Desktop Specialty
          - az-800     # Windows Server Hybrid Administrator (exam 1)
          - az-801     # Windows Server Hybrid Administrator (exam 2)
          # === AI & DATA ===
          - ai-900     # Azure AI Fundamentals
          - ai-102     # Azure AI Engineer
          - dp-900     # Azure Data Fundamentals
          - dp-100     # Azure Data Scientist
          - dp-203     # Azure Data Engineer
          - dp-300     # Azure Database Administrator
          - dp-600     # Microsoft Fabric Analytics Engineer
          - dp-700     # Microsoft Fabric Data Engineer (if available)
          # === SECURITY ===
          - sc-900     # Security, Compliance, Identity Fundamentals
          - sc-100     # Cybersecurity Architect Expert
          - sc-200     # Security Operations Analyst
          - sc-300     # Identity and Access Administrator
          - sc-400     # Information Protection and Compliance Admin
          # === MICROSOFT 365 ===
          - ms-900     # Microsoft 365 Fundamentals
          - ms-102     # Microsoft 365 Administrator
          - ms-700     # Microsoft Teams Administrator
          - md-102     # Endpoint Administrator
          # === POWER PLATFORM ===
          - pl-900     # Power Platform Fundamentals
          - pl-100     # Power Platform App Maker
          - pl-200     # Power Platform Functional Consultant
          - pl-300     # Power BI Data Analyst
          - pl-400     # Power Platform Developer
          - pl-500     # Power Automate RPA Developer
          - pl-600     # Power Platform Solution Architect Expert
          # === DYNAMICS 365 ===
          - mb-910     # Dynamics 365 Fundamentals (CRM)
          - mb-920     # Dynamics 365 Fundamentals (ERP)
          - mb-210     # Dynamics 365 Sales Functional Consultant
          - mb-220     # Dynamics 365 Customer Insights - Journeys
          - mb-230     # Dynamics 365 Customer Service
          - mb-240     # Dynamics 365 Field Service
          - mb-260     # Dynamics 365 Customer Insights - Data
          - mb-300     # Dynamics 365 Core Finance and Operations
          - mb-310     # Dynamics 365 Finance Functional Consultant
          - mb-330     # Dynamics 365 Supply Chain Management
          - mb-335     # Dynamics 365 Supply Chain Management Expert
          - mb-500     # Dynamics 365 Finance & Operations Apps Developer
          - mb-700     # Dynamics 365 Finance & Operations Solution Architect
          - mb-800     # Dynamics 365 Business Central Functional Consultant
          - mb-820     # Dynamics 365 Business Central Developer
        default: 'ai-102'
      audioFormat:
        description: 'Audio format'
        required: true
        type: choice
        options:
          - instructional
          - podcast
        default: 'instructional'
      examPageUrl:
        description: 'Override exam page URL (optional, auto-discovered if empty)'
        required: false
        default: ''

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

# =============================================================================
# REQUIRED SECRETS (configure in GitHub Settings > Secrets > Actions):
# - AZURE_CLIENT_ID:        Service principal/app registration client ID
# - AZURE_TENANT_ID:        Azure AD tenant ID  
# - AZURE_SUBSCRIPTION_ID:  Azure subscription ID
# - AZURE_RESOURCE_GROUP:   Resource group name (e.g., rg-certaudio-dev)
# =============================================================================

jobs:
  check-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets are configured
        run: |
          missing=""
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then missing="$missing AZURE_CLIENT_ID"; fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then missing="$missing AZURE_TENANT_ID"; fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then missing="$missing AZURE_SUBSCRIPTION_ID"; fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP }}" ]; then missing="$missing AZURE_RESOURCE_GROUP"; fi
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            echo ""
            echo "Configure these secrets in GitHub: Settings > Secrets and variables > Actions"
            echo "See README.md for setup instructions."
            exit 1
          fi
          echo "âœ… All required secrets are configured"

  discover-content:
    name: Discover Exam Content
    needs: check-secrets
    runs-on: ubuntu-latest
    outputs:
      skillsOutline: ${{ steps.discover.outputs.skillsOutline }}
      sourceUrls: ${{ steps.discover.outputs.sourceUrls }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/pipeline
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Discover exam content
        id: discover
        env:
          CERTIFICATION_ID: ${{ inputs.certificationId }}
          EXAM_PAGE_URL: ${{ inputs.examPageUrl }}
          DOCUMENT_INTELLIGENCE_ENDPOINT: ${{ secrets.DOCUMENT_INTELLIGENCE_ENDPOINT }}
          SEARCH_ENDPOINT: ${{ secrets.SEARCH_ENDPOINT }}
          COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
        run: |
          cd src/pipeline
          python -m tools.discover_exam_content \
            --certification-id "$CERTIFICATION_ID" \
            --exam-page-url "$EXAM_PAGE_URL" \
            --output-file /tmp/discovery_results.json
          
          echo "skillsOutline=$(cat /tmp/discovery_results.json | jq -c '.skillsOutline')" >> $GITHUB_OUTPUT
          echo "sourceUrls=$(cat /tmp/discovery_results.json | jq -c '.sourceUrls')" >> $GITHUB_OUTPUT

  index-content:
    name: Index Content for RAG
    runs-on: ubuntu-latest
    needs: discover-content
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/pipeline
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Index content in AI Search
        env:
          SOURCE_URLS: ${{ needs.discover-content.outputs.sourceUrls }}
          CERTIFICATION_ID: ${{ inputs.certificationId }}
          SEARCH_ENDPOINT: ${{ secrets.SEARCH_ENDPOINT }}
          OPENAI_ENDPOINT: ${{ secrets.OPENAI_ENDPOINT }}
          COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
        run: |
          cd src/pipeline
          python -m tools.index_content \
            --certification-id "$CERTIFICATION_ID" \
            --source-urls "$SOURCE_URLS"

  generate-episodes:
    name: Generate Episodes
    runs-on: ubuntu-latest
    needs: [discover-content, index-content]
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4]  # Process in batches to avoid timeouts
      max-parallel: 2
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd src/pipeline
          pip install -r requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate episode batch
        env:
          CERTIFICATION_ID: ${{ inputs.certificationId }}
          AUDIO_FORMAT: ${{ inputs.audioFormat }}
          SKILLS_OUTLINE: ${{ needs.discover-content.outputs.skillsOutline }}
          BATCH_INDEX: ${{ matrix.batch }}
          OPENAI_ENDPOINT: ${{ secrets.OPENAI_ENDPOINT }}
          SPEECH_ENDPOINT: ${{ secrets.SPEECH_ENDPOINT }}
          SEARCH_ENDPOINT: ${{ secrets.SEARCH_ENDPOINT }}
          STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
          COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
        run: |
          cd src/pipeline
          python -m tools.generate_episodes \
            --certification-id "$CERTIFICATION_ID" \
            --audio-format "$AUDIO_FORMAT" \
            --skills-outline "$SKILLS_OUTLINE" \
            --batch-index "$BATCH_INDEX" \
            --batch-size 10

  finalize:
    name: Finalize Content Generation
    runs-on: ubuntu-latest
    needs: generate-episodes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate episode index
        env:
          CERTIFICATION_ID: ${{ inputs.certificationId }}
          AUDIO_FORMAT: ${{ inputs.audioFormat }}
          COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
          STORAGE_ACCOUNT_NAME: ${{ secrets.STORAGE_ACCOUNT_NAME }}
        run: |
          cd src/pipeline
          pip install -r requirements.txt
          python -m tools.generate_index \
            --certification-id "$CERTIFICATION_ID" \
            --audio-format "$AUDIO_FORMAT"

      - name: Output generation summary
        run: |
          echo "## Content Generation Complete! :headphones:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Certification | ${{ inputs.certificationId }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format | ${{ inputs.audioFormat }} |" >> $GITHUB_STEP_SUMMARY
