name: Deploy Infrastructure

concurrency:
  group: deploy-infra-${{ github.ref }}
  cancel-in-progress: true

on:
  # Only triggers on infra changes or manual dispatch - NOT on src/** changes.
  # Use workflow_dispatch to manually deploy after code changes if needed.
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - '.github/workflows/deploy-infra.yml'
  workflow_dispatch:
    inputs:
      certificationId:
        description: 'Microsoft certification ID'
        required: true
        type: choice
        options:
          # === AZURE ===
          - az-900     # Azure Fundamentals
          - az-104     # Azure Administrator
          - az-204     # Azure Developer
          - az-305     # Azure Solutions Architect Expert
          - az-400     # Azure DevOps Engineer Expert
          - az-500     # Azure Security Engineer
          - az-700     # Azure Network Engineer
          - az-140     # Azure Virtual Desktop Specialty
          - az-800     # Windows Server Hybrid Administrator (exam 1)
          - az-801     # Windows Server Hybrid Administrator (exam 2)
          # === AI & DATA ===
          - ai-900     # Azure AI Fundamentals
          - ai-102     # Azure AI Engineer
          - dp-900     # Azure Data Fundamentals
          - dp-100     # Azure Data Scientist
          - dp-203     # Azure Data Engineer
          - dp-300     # Azure Database Administrator
          - dp-600     # Microsoft Fabric Analytics Engineer
          - dp-700     # Microsoft Fabric Data Engineer (if available)
          # === SECURITY ===
          - sc-900     # Security, Compliance, Identity Fundamentals
          - sc-100     # Cybersecurity Architect Expert
          - sc-200     # Security Operations Analyst
          - sc-300     # Identity and Access Administrator
          - sc-400     # Information Protection and Compliance Admin
          # === MICROSOFT 365 ===
          - ms-900     # Microsoft 365 Fundamentals
          - ms-102     # Microsoft 365 Administrator
          - ms-700     # Microsoft Teams Administrator
          - md-102     # Endpoint Administrator
          # === POWER PLATFORM ===
          - pl-900     # Power Platform Fundamentals
          - pl-100     # Power Platform App Maker
          - pl-200     # Power Platform Functional Consultant
          - pl-300     # Power BI Data Analyst
          - pl-400     # Power Platform Developer
          - pl-500     # Power Automate RPA Developer
          - pl-600     # Power Platform Solution Architect Expert
          # === DYNAMICS 365 ===
          - mb-910     # Dynamics 365 Fundamentals (CRM)
          - mb-920     # Dynamics 365 Fundamentals (ERP)
          - mb-210     # Dynamics 365 Sales Functional Consultant
          - mb-220     # Dynamics 365 Customer Insights - Journeys
          - mb-230     # Dynamics 365 Customer Service
          - mb-240     # Dynamics 365 Field Service
          - mb-260     # Dynamics 365 Customer Insights - Data
          - mb-300     # Dynamics 365 Core Finance and Operations
          - mb-310     # Dynamics 365 Finance Functional Consultant
          - mb-330     # Dynamics 365 Supply Chain Management
          - mb-335     # Dynamics 365 Supply Chain Management Expert
          - mb-500     # Dynamics 365 Finance & Operations Apps Developer
          - mb-700     # Dynamics 365 Finance & Operations Solution Architect
          - mb-800     # Dynamics 365 Business Central Functional Consultant
          - mb-820     # Dynamics 365 Business Central Developer
        default: 'ai-102'
      audioFormat:
        description: 'Audio format'
        required: true
        type: choice
        options:
          - instructional
          - podcast
        default: 'instructional'
      enableB2C:
        description: 'Enable Azure AD B2C authentication'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  # Primary location - centralus supports all required services and has better capacity:
  # Static Web Apps, Speech, Search, Cosmos DB, Storage, Functions
  LOCATION: 'centralus'
  # OpenAI location - separate region since centralus doesn't support GPT-4o GlobalStandard
  OPENAI_LOCATION: 'eastus'
  # Controls the resource-name suffix used by Bicep.
  # - Set secret AZURE_UNIQUE_SUFFIX to pin deployments to a single stable environment (recommended).
  # - If unset, falls back to github.run_id, which avoids name collisions but creates new resources every run.
  UNIQUE_SUFFIX: ${{ secrets.AZURE_UNIQUE_SUFFIX || github.run_id }}

# =============================================================================
# REQUIRED SECRETS (configure in GitHub Settings > Secrets > Actions):
# - AZURE_CLIENT_ID:        Service principal/app registration client ID
# - AZURE_TENANT_ID:        Azure AD tenant ID  
# - AZURE_SUBSCRIPTION_ID:  Azure subscription ID
# - AZURE_RESOURCE_GROUP:   Resource group name (e.g., rg-certaudio-dev)
# OPTIONAL:
# - AZURE_UNIQUE_SUFFIX:    Pin resource name suffix to avoid creating new resources each run
# =============================================================================

jobs:
  check-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets are configured
        run: |
          missing=""
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then missing="$missing AZURE_CLIENT_ID"; fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then missing="$missing AZURE_TENANT_ID"; fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then missing="$missing AZURE_SUBSCRIPTION_ID"; fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP }}" ]; then missing="$missing AZURE_RESOURCE_GROUP"; fi
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            echo ""
            echo "Configure these secrets in GitHub: Settings > Secrets and variables > Actions"
            echo "See README.md for setup instructions."
            exit 1
          fi
          echo "âœ… All required secrets are configured"

  validate:
    name: Validate Bicep
    needs: check-secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep template
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            accessToken=$(az account get-access-token \
              --resource https://management.azure.com \
              --query accessToken -o tsv)
            export ACCESS_TOKEN="$accessToken"

            automationPrincipalId=$(python3 - <<'PY'
            import os, json, base64
            token = os.environ.get('ACCESS_TOKEN', '')
            parts = token.split('.')
            if len(parts) < 2:
              print('')
              raise SystemExit(0)
            payload = parts[1]
            payload += '=' * (-len(payload) % 4)
            data = base64.urlsafe_b64decode(payload.encode('utf-8')).decode('utf-8')
            claims = json.loads(data)
            print(claims.get('oid') or claims.get('objectId') or '')
            PY
            )

            if [[ -z "$automationPrincipalId" ]]; then
              echo "::warning::Could not determine automation principal objectId from access token; Cosmos SQL RBAC for automation will not be applied."
            else
              echo "Automation principal objectId: $automationPrincipalId"
            fi

            deploymentName="certaudio-${{ github.run_id }}-${{ github.run_attempt }}"

            az deployment group validate \
              --name "$deploymentName" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --template-file ./infra/main.bicep \
              --parameters \
                certificationId=${{ inputs.certificationId || 'ai-102' }} \
                audioFormat=${{ inputs.audioFormat || 'instructional' }} \
                enableB2C=${{ inputs.enableB2C || false }} \
                uniqueSuffix=$UNIQUE_SUFFIX \
                location=$LOCATION \
                openAiLocation=$OPENAI_LOCATION \
                automationPrincipalId=$automationPrincipalId

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      staticWebAppUrl: ${{ steps.deploy.outputs.staticWebAppUrl }}
      staticWebAppName: ${{ steps.deploy.outputs.staticWebAppName }}
      functionsAppName: ${{ steps.deploy.outputs.functionsAppName }}
      storageAccountName: ${{ steps.deploy.outputs.storageAccountName }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep template
        id: deploy
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            accessToken=$(az account get-access-token \
              --resource https://management.azure.com \
              --query accessToken -o tsv)
            export ACCESS_TOKEN="$accessToken"

            automationPrincipalId=$(python3 - <<'PY'
            import os, json, base64
            token = os.environ.get('ACCESS_TOKEN', '')
            parts = token.split('.')
            if len(parts) < 2:
              print('')
              raise SystemExit(0)
            payload = parts[1]
            payload += '=' * (-len(payload) % 4)
            data = base64.urlsafe_b64decode(payload.encode('utf-8')).decode('utf-8')
            claims = json.loads(data)
            print(claims.get('oid') or claims.get('objectId') or '')
            PY
            )

            if [[ -z "$automationPrincipalId" ]]; then
              echo "::warning::Could not determine automation principal objectId from access token; Cosmos SQL RBAC for automation will not be applied."
            else
              echo "Automation principal objectId: $automationPrincipalId"
            fi

            deploymentName="certaudio-${{ github.run_id }}-${{ github.run_attempt }}"

            if ! deploymentOutputs=$(az deployment group create \
              --name "$deploymentName" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --template-file ./infra/main.bicep \
              --parameters \
                certificationId=${{ inputs.certificationId || 'ai-102' }} \
                audioFormat=${{ inputs.audioFormat || 'instructional' }} \
                enableB2C=${{ inputs.enableB2C || false }} \
                uniqueSuffix=$UNIQUE_SUFFIX \
                location=$LOCATION \
                openAiLocation=$OPENAI_LOCATION \
                automationPrincipalId=$automationPrincipalId \
              --query "properties.outputs" \
              -o json \
              --only-show-errors); then
              echo "::group::Deployment error (properties.error)"
              az deployment group show \
                --name "$deploymentName" \
                --resource-group "$AZURE_RESOURCE_GROUP" \
                --query properties.error \
                -o jsonc || true
              echo "::endgroup::"

              echo "::group::Failed deployment operations"
              az deployment operation group list \
                --name "$deploymentName" \
                --resource-group "$AZURE_RESOURCE_GROUP" \
                --query "[?properties.provisioningState=='Failed'].{resource:properties.targetResource.resourceName, type:properties.targetResource.resourceType, state:properties.provisioningState, message:properties.statusMessage}" \
                -o table || true
              echo "::endgroup::"

              exit 1
            fi

            # Read outputs from the deployment create response to avoid timing issues where
            # `az deployment group show` can briefly return empty outputs.
            if [[ -z "${deploymentOutputs// }" || "$deploymentOutputs" == "null" ]]; then
              deploymentOutputs='{}'
            fi

            staticWebAppUrl=$(echo "$deploymentOutputs" | python3 - <<'PY'
            import json, sys
            d = json.load(sys.stdin)
            print(d.get('staticWebAppUrl', {}).get('value', '') or '')
            PY
            )
            staticWebAppName=$(echo "$deploymentOutputs" | python3 - <<'PY'
            import json, sys
            d = json.load(sys.stdin)
            print(d.get('staticWebAppName', {}).get('value', '') or '')
            PY
            )
            functionsAppName=$(echo "$deploymentOutputs" | python3 - <<'PY'
            import json, sys
            d = json.load(sys.stdin)
            print(d.get('functionsAppName', {}).get('value', '') or '')
            PY
            )
            storageAccountName=$(echo "$deploymentOutputs" | python3 - <<'PY'
            import json, sys
            d = json.load(sys.stdin)
            print(d.get('storageAccountName', {}).get('value', '') or '')
            PY
            )
            cosmosDbAccountName=$(echo "$deploymentOutputs" | python3 - <<'PY'
            import json, sys
            d = json.load(sys.stdin)
            print(d.get('cosmosDbAccountName', {}).get('value', '') or '')
            PY
            )

            if [[ -z "$functionsAppName" || -z "$staticWebAppName" ]]; then
              echo "::warning::Deployment outputs missing from create response; falling back to deployment show."
              deploymentOutputs=$(az deployment group show \
                --name "$deploymentName" \
                --resource-group "$AZURE_RESOURCE_GROUP" \
                --query "properties.outputs" \
                -o json \
                --only-show-errors)

              if [[ -z "${deploymentOutputs// }" || "$deploymentOutputs" == "null" ]]; then
                deploymentOutputs='{}'
              fi

              staticWebAppUrl=$(echo "$deploymentOutputs" | python3 - <<'PY'
              import json, sys
              d = json.load(sys.stdin)
              print(d.get('staticWebAppUrl', {}).get('value', '') or '')
              PY
              )
              staticWebAppName=$(echo "$deploymentOutputs" | python3 - <<'PY'
              import json, sys
              d = json.load(sys.stdin)
              print(d.get('staticWebAppName', {}).get('value', '') or '')
              PY
              )
              functionsAppName=$(echo "$deploymentOutputs" | python3 - <<'PY'
              import json, sys
              d = json.load(sys.stdin)
              print(d.get('functionsAppName', {}).get('value', '') or '')
              PY
              )
              storageAccountName=$(echo "$deploymentOutputs" | python3 - <<'PY'
              import json, sys
              d = json.load(sys.stdin)
              print(d.get('storageAccountName', {}).get('value', '') or '')
              PY
              )
              cosmosDbAccountName=$(echo "$deploymentOutputs" | python3 - <<'PY'
              import json, sys
              d = json.load(sys.stdin)
              print(d.get('cosmosDbAccountName', {}).get('value', '') or '')
              PY
              )
            fi

            echo "Resolved output names: functionsAppName='$functionsAppName', staticWebAppName='$staticWebAppName'"
            if [[ -z "$functionsAppName" || -z "$staticWebAppName" ]]; then
              echo "::error::Unable to resolve deployment outputs for Functions/SWA. Aborting before downstream deploy steps."
              exit 1
            fi

            echo "staticWebAppUrl=$staticWebAppUrl" >> "$GITHUB_OUTPUT"
            echo "staticWebAppName=$staticWebAppName" >> "$GITHUB_OUTPUT"
            echo "functionsAppName=$functionsAppName" >> "$GITHUB_OUTPUT"
            echo "storageAccountName=$storageAccountName" >> "$GITHUB_OUTPUT"
            echo "cosmosDbAccountName=$cosmosDbAccountName" >> "$GITHUB_OUTPUT"

      - name: Output deployment results
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Static Web App URL | ${{ steps.deploy.outputs.staticWebAppUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions App | ${{ steps.deploy.outputs.functionsAppName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | ${{ steps.deploy.outputs.storageAccountName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cosmos DB | ${{ steps.deploy.outputs.cosmosDbAccountName }} |" >> $GITHUB_STEP_SUMMARY

  deploy-functions:
    name: Deploy Functions App
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install dependencies
        run: |
          cd src/functions
          python -m pip install --upgrade pip
          # Package dependencies into the Azure Functions expected folder layout
          python -m pip install -r requirements.txt --target ".python_packages/lib/site-packages"

      - name: Zip Functions package
        run: |
          cd src/functions
          zip -r "$GITHUB_WORKSPACE/functions.zip" .

      - name: Deploy to Azure Functions (zip deploy)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            az functionapp deployment source config-zip \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "${{ needs.deploy.outputs.functionsAppName }}" \
              --src "functions.zip"

  deploy-static-web-app:
    name: Deploy Static Web App
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Static Web App deployment token
        id: swaToken
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            token=$(az staticwebapp secrets list \
              --name "${{ needs.deploy.outputs.staticWebAppName }}" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --query properties.apiKey -o tsv)
            echo "token=$token" >> "$GITHUB_OUTPUT"

      - name: Deploy Static Web App
        uses: azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swaToken.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'src/web'
          output_location: ''
          skip_api_build: true
