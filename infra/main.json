{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "9959727981662070551"
    }
  },
  "parameters": {
    "certificationId": {
      "type": "string",
      "defaultValue": "ai-102",
      "metadata": {
        "description": "Microsoft certification ID (e.g., ai-102, az-204, az-104)"
      }
    },
    "audioFormat": {
      "type": "string",
      "defaultValue": "instructional",
      "allowedValues": [
        "instructional",
        "podcast"
      ],
      "metadata": {
        "description": "Audio format for the course"
      }
    },
    "enableB2C": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable Azure AD B2C authentication"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "prod"
      ],
      "metadata": {
        "description": "Environment name for resource naming"
      }
    },
    "uniqueSuffix": {
      "type": "string",
      "defaultValue": "[uniqueString(resourceGroup().id)]",
      "metadata": {
        "description": "Unique suffix for globally unique resource names"
      }
    },
    "openAiLocation": {
      "type": "string",
      "defaultValue": "eastus2",
      "allowedValues": [
        "eastus",
        "eastus2",
        "westus",
        "westus3",
        "northcentralus",
        "southcentralus",
        "westeurope",
        "swedencentral"
      ],
      "metadata": {
        "description": "Location for Azure OpenAI (GPT-4o has limited regional availability)"
      }
    }
  },
  "variables": {
    "baseName": "certaudio",
    "resourcePrefix": "[format('{0}-{1}', variables('baseName'), parameters('environment'))]",
    "tags": {
      "project": "certification-audio-platform",
      "certification": "[parameters('certificationId')]",
      "environment": "[parameters('environment')]",
      "audioFormat": "[parameters('audioFormat')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-ai-services",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "openAiLocation": {
            "value": "[parameters('openAiLocation')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14810148298819193736"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "uniqueSuffix": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "openAiLocation": {
              "type": "string",
              "defaultValue": "eastus2",
              "metadata": {
                "description": "Location for Azure OpenAI (may differ from main location due to model availability)"
              }
            }
          },
          "variables": {
            "openAiName": "[format('{0}-openai-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "speechName": "[format('{0}-speech-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "docIntelName": "[format('{0}-docintel-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "searchName": "[format('{0}-search-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-04-01-preview",
              "name": "[variables('openAiName')]",
              "location": "[parameters('openAiLocation')]",
              "tags": "[parameters('tags')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[variables('openAiName')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-04-01-preview",
              "name": "[format('{0}/{1}', variables('openAiName'), 'gpt-4o')]",
              "sku": {
                "name": "GlobalStandard",
                "capacity": 30
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4o",
                  "version": "2024-08-06"
                },
                "raiPolicyName": "Microsoft.Default"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-04-01-preview",
              "name": "[format('{0}/{1}', variables('openAiName'), 'text-embedding-3-large')]",
              "sku": {
                "name": "Standard",
                "capacity": 30
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-3-large",
                  "version": "1"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', variables('openAiName'), 'gpt-4o')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-04-01-preview",
              "name": "[variables('speechName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "SpeechServices",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[variables('speechName')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-04-01-preview",
              "name": "[variables('docIntelName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "FormRecognizer",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[variables('docIntelName')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2024-03-01-preview",
              "name": "[variables('searchName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "basic"
              },
              "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "hostingMode": "default",
                "publicNetworkAccess": "enabled",
                "semanticSearch": "free"
              }
            }
          ],
          "outputs": {
            "openAiName": {
              "type": "string",
              "value": "[variables('openAiName')]"
            },
            "openAiEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiName')), '2024-04-01-preview').endpoint]"
            },
            "openAiId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiName'))]"
            },
            "speechName": {
              "type": "string",
              "value": "[variables('speechName')]"
            },
            "speechEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('speechName')), '2024-04-01-preview').endpoint]"
            },
            "speechId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', variables('speechName'))]"
            },
            "documentIntelligenceName": {
              "type": "string",
              "value": "[variables('docIntelName')]"
            },
            "documentIntelligenceEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('docIntelName')), '2024-04-01-preview').endpoint]"
            },
            "documentIntelligenceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', variables('docIntelName'))]"
            },
            "searchName": {
              "type": "string",
              "value": "[variables('searchName')]"
            },
            "searchEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', variables('searchName'))]"
            },
            "searchId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Search/searchServices', variables('searchName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-data",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "certificationId": {
            "value": "[parameters('certificationId')]"
          },
          "audioFormat": {
            "value": "[parameters('audioFormat')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14172720420128194726"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "uniqueSuffix": {
              "type": "string"
            },
            "certificationId": {
              "type": "string"
            },
            "audioFormat": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "cosmosDbName": "[format('{0}-cosmos-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "storageNameRaw": "[toLower(replace(format('{0}st{1}', parameters('resourcePrefix'), parameters('uniqueSuffix')), '-', ''))]",
            "storageAccountName": "[take(variables('storageNameRaw'), 24)]",
            "databaseName": "certaudio"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2024-05-15",
              "name": "[variables('cosmosDbName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "enableFreeTier": false
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}', variables('cosmosDbName'), variables('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[variables('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosDbName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', variables('cosmosDbName'), variables('databaseName'), 'episodes')]",
              "properties": {
                "resource": {
                  "id": "episodes",
                  "partitionKey": {
                    "paths": [
                      "/certificationId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosDbName'), variables('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', variables('cosmosDbName'), variables('databaseName'), 'sources')]",
              "properties": {
                "resource": {
                  "id": "sources",
                  "partitionKey": {
                    "paths": [
                      "/certificationId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosDbName'), variables('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', variables('cosmosDbName'), variables('databaseName'), 'userProgress')]",
              "properties": {
                "resource": {
                  "id": "userProgress",
                  "partitionKey": {
                    "paths": [
                      "/userId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosDbName'), variables('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', format('audio-{0}-{1}', parameters('certificationId'), parameters('audioFormat')))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', format('scripts-{0}-{1}', parameters('certificationId'), parameters('audioFormat')))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "cosmosDbAccountName": {
              "type": "string",
              "value": "[variables('cosmosDbName')]"
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosDbName')), '2024-05-15').documentEndpoint]"
            },
            "cosmosDbId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosDbName'))]"
            },
            "cosmosDbDatabaseName": {
              "type": "string",
              "value": "[variables('databaseName')]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[variables('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "blobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-05-01').primaryEndpoints.blob]"
            },
            "audioContainerName": {
              "type": "string",
              "value": "[format('audio-{0}-{1}', parameters('certificationId'), parameters('audioFormat'))]"
            },
            "scriptsContainerName": {
              "type": "string",
              "value": "[format('scripts-{0}-{1}', parameters('certificationId'), parameters('audioFormat'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-web",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSuffix": {
            "value": "[parameters('uniqueSuffix')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-data'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "cosmosDbAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-data'), '2025-04-01').outputs.cosmosDbAccountName.value]"
          },
          "cosmosDbDatabaseName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-data'), '2025-04-01').outputs.cosmosDbDatabaseName.value]"
          },
          "openAiEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.openAiEndpoint.value]"
          },
          "speechEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.speechEndpoint.value]"
          },
          "searchEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.searchEndpoint.value]"
          },
          "enableB2C": {
            "value": "[parameters('enableB2C')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4895780466259512023"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "uniqueSuffix": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "cosmosDbAccountName": {
              "type": "string"
            },
            "cosmosDbDatabaseName": {
              "type": "string"
            },
            "openAiEndpoint": {
              "type": "string"
            },
            "speechEndpoint": {
              "type": "string"
            },
            "searchEndpoint": {
              "type": "string"
            },
            "enableB2C": {
              "type": "bool"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "staticWebAppName": "[format('{0}-swa-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "functionsAppName": "[format('{0}-func-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "appServicePlanName": "[format('{0}-asp-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "appInsightsName": "[format('{0}-insights-{1}', parameters('resourcePrefix'), parameters('uniqueSuffix'))]",
            "funcStorageNameRaw": "[toLower(replace(format('{0}fn{1}', parameters('resourcePrefix'), parameters('uniqueSuffix')), '-', ''))]",
            "funcStorageAccountName": "[take(variables('funcStorageNameRaw'), 24)]"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "Request_Source": "rest",
                "RetentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[variables('funcStorageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true
              }
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[variables('functionsAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "Python|3.11",
                  "pythonVersion": "3.11",
                  "cors": {
                    "allowedOrigins": [
                      "*"
                    ],
                    "supportCredentials": false
                  },
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('funcStorageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('funcStorageAccountName')), '2023-05-01').keys[0].value)]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "python"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
                    },
                    {
                      "name": "STORAGE_ACCOUNT_NAME",
                      "value": "[parameters('storageAccountName')]"
                    },
                    {
                      "name": "COSMOS_DB_ENDPOINT",
                      "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2024-05-15').documentEndpoint]"
                    },
                    {
                      "name": "COSMOS_DB_DATABASE",
                      "value": "[parameters('cosmosDbDatabaseName')]"
                    },
                    {
                      "name": "OPENAI_ENDPOINT",
                      "value": "[parameters('openAiEndpoint')]"
                    },
                    {
                      "name": "SPEECH_ENDPOINT",
                      "value": "[parameters('speechEndpoint')]"
                    },
                    {
                      "name": "SEARCH_ENDPOINT",
                      "value": "[parameters('searchEndpoint')]"
                    },
                    {
                      "name": "ENABLE_B2C",
                      "value": "[string(parameters('enableB2C'))]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]",
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('funcStorageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-12-01",
              "name": "[variables('staticWebAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard"
              },
              "properties": {
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "buildProperties": {
                  "appLocation": "src/web",
                  "apiLocation": "",
                  "outputLocation": ""
                }
              }
            },
            {
              "type": "Microsoft.Web/staticSites/linkedBackends",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', variables('staticWebAppName'), 'backend')]",
              "properties": {
                "backendResourceId": "[resourceId('Microsoft.Web/sites', variables('functionsAppName'))]",
                "region": "[parameters('location')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('functionsAppName'))]",
                "[resourceId('Microsoft.Web/staticSites', variables('staticWebAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), resourceId('Microsoft.Web/sites', variables('functionsAppName')), 'Storage Blob Data Reader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('functionsAppName')), '2023-12-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('functionsAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosDbAccountName'))]",
              "name": "[guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), resourceId('Microsoft.Web/sites', variables('functionsAppName')), 'Cosmos DB Data Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00000000-0000-0000-0000-000000000002')]",
                "principalId": "[reference(resourceId('Microsoft.Web/sites', variables('functionsAppName')), '2023-12-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('functionsAppName'))]"
              ]
            }
          ],
          "outputs": {
            "staticWebAppName": {
              "type": "string",
              "value": "[variables('staticWebAppName')]"
            },
            "staticWebAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', variables('staticWebAppName')), '2023-12-01').defaultHostname)]"
            },
            "staticWebAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/staticSites', variables('staticWebAppName'))]"
            },
            "functionsAppName": {
              "type": "string",
              "value": "[variables('functionsAppName')]"
            },
            "functionsAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', variables('functionsAppName')), '2023-12-01').defaultHostName)]"
            },
            "functionsAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('functionsAppName'))]"
            },
            "functionsAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('functionsAppName')), '2023-12-01', 'full').identity.principalId]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[variables('appInsightsName')]"
            },
            "appInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').ConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-ai-services')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-data')]"
      ]
    },
    {
      "condition": "[parameters('enableB2C')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "staticWebAppName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-web'), '2025-04-01').outputs.staticWebAppName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16622633623681261333"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string"
            },
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of Static Web App to configure with B2C"
              }
            }
          },
          "variables": {
            "b2cTenantName": "[format('{0}b2c', replace(parameters('resourcePrefix'), '-', ''))]",
            "b2cDisplayName": "Certification Audio Platform"
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', parameters('staticWebAppName'), 'appsettings')]",
              "properties": {
                "AZURE_AD_B2C_TENANT_NAME": "[variables('b2cTenantName')]",
                "AZURE_AD_B2C_CLIENT_ID": "TO_BE_CONFIGURED",
                "AZURE_AD_B2C_POLICY_NAME": "B2C_1_signupsignin"
              }
            }
          ],
          "outputs": {
            "b2cTenantName": {
              "type": "string",
              "value": "[variables('b2cTenantName')]"
            },
            "b2cDisplayName": {
              "type": "string",
              "value": "[variables('b2cDisplayName')]"
            },
            "b2cAuthorityDomain": {
              "type": "string",
              "value": "[format('{0}.b2clogin.com', variables('b2cTenantName'))]"
            },
            "b2cSignUpSignInPolicy": {
              "type": "string",
              "value": "B2C_1_signupsignin"
            },
            "manualConfigurationRequired": {
              "type": "string",
              "value": "Azure AD B2C requires manual configuration:\n\n1. Create B2C Tenant:\n   az ad b2c tenant create --tenant-name ${b2cTenantName} --resource-group <rg> --location <location>\n\n2. Create User Flow in Azure Portal:\n   - Go to Azure AD B2C > User flows\n   - Create \"Sign up and sign in\" flow named \"B2C_1_signupsignin\"\n   - Enable Email signup, Display name, Given name\n\n3. Register Application:\n   - Go to Azure AD B2C > App registrations\n   - Register new app for Static Web App\n   - Add redirect URI: https://<staticwebapp>.azurestaticapps.net/.auth/login/aadb2c/callback\n   - Copy Client ID to AZURE_AD_B2C_CLIENT_ID setting\n\n4. Update staticwebapp.config.json with B2C settings\n"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-web')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-data'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "cosmosDbAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-data'), '2025-04-01').outputs.cosmosDbAccountName.value]"
    },
    "staticWebAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-web'), '2025-04-01').outputs.staticWebAppName.value]"
    },
    "staticWebAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-web'), '2025-04-01').outputs.staticWebAppUrl.value]"
    },
    "functionsAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-web'), '2025-04-01').outputs.functionsAppName.value]"
    },
    "openAiEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.openAiEndpoint.value]"
    },
    "speechEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.speechEndpoint.value]"
    },
    "searchEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.searchEndpoint.value]"
    },
    "documentIntelligenceEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-ai-services'), '2025-04-01').outputs.documentIntelligenceEndpoint.value]"
    },
    "b2cTenantName": {
      "type": "string",
      "value": "[if(and(parameters('enableB2C'), not(equals(reference(resourceId('Microsoft.Resources/deployments', 'deploy-identity'), '2025-04-01'), null()))), reference(resourceId('Microsoft.Resources/deployments', 'deploy-identity'), '2025-04-01').outputs.b2cTenantName.value, 'N/A - B2C disabled')]"
    }
  }
}